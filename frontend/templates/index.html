{% extends "base.html" %}

{% block title %}ì´ìƒí˜• ì„ íƒë¥  ê³„ì‚°ê¸° - ë‹¹ì‹ ì´ ì›í•˜ëŠ” ì´ì„±ì€ ëª‡ %ì¼ê¹Œ?{% endblock %}

{% block content %}
<div class="hero-section">
    <h1 class="hero-title">ì´ìƒí˜• ì„ íƒë¥  ê³„ì‚°ê¸°</h1>
    <p class="hero-subtitle">ë‹¹ì‹ ì´ ì›í•˜ëŠ” ì´ìƒí˜•ì´ ì „ì²´ ì´ì„± ì¤‘ ëª‡ %ì¼ê¹Œìš”?<br>ì‹¤ì œ í†µê³„ë¡œ ì •í™•íˆ ê³„ì‚°í•´ë“œë¦½ë‹ˆë‹¤!</p>
</div>

<div class="main-content">
    <!-- ì¡°ê±´ ì…ë ¥ í¼ -->
    <div class="form-section">
        <h2>ì´ìƒí˜• ì¡°ê±´ ì…ë ¥</h2>
        <p class="form-description">ì›í•˜ëŠ” ì´ìƒí˜•ì˜ ì¡°ê±´ì„ ì„ íƒí•´ë³´ì„¸ìš”. ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ì¡°ê±´ì€ ì œì™¸ë©ë‹ˆë‹¤.</p>
        
        <form id="idealTypeForm" class="ideal-type-form" data-managed="inline">
            <!-- ì„±ë³„ ì„ íƒ -->
            <div class="form-group">
                <label for="gender">ì´ìƒí˜• ì„±ë³„ *</label>
                <select id="gender" name="gender" required>
                    <option value="">ì„±ë³„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ë‚¨ì„±">ë‚¨ì„±</option>
                    <option value="ì—¬ì„±">ì—¬ì„±</option>
                </select>
                <small class="form-text">* í•„ìˆ˜ ì„ íƒ í•­ëª©ì…ë‹ˆë‹¤</small>
            </div>

            <!-- í‚¤ ì¡°ê±´ (ë“€ì–¼ ìŠ¬ë¼ì´ë” + ìƒê´€ì—†ìŒ) -->
            <div class="form-group">
                <label>í‚¤ (cm)
                    <label class="any-toggle"><input type="checkbox" id="heightAny"> ìƒê´€ì—†ìŒ</label>
                </label>
                <div class="range-row" id="heightControls">
                    <input type="number" id="heightMin" min="140" max="200" step="1" placeholder="ìµœì†Œ" value="165">
                    <div id="heightSlider" class="nu-slider"></div>
                    <input type="number" id="heightMax" min="140" max="200" step="1" placeholder="ìµœëŒ€" value="175">
                </div>
                <small class="form-text" id="heightHint">ì„ íƒ: 165â€“175cm</small>
            </div>

            <!-- í•™ë ¥ ì¡°ê±´ (ì¹©/ë‹¤ì¤‘ì„ íƒ) -->
            <div class="form-group">
                <label>í•™ë ¥
                    <label class="any-toggle"><input type="checkbox" id="educationAny"> ìƒê´€ì—†ìŒ</label>
                </label>
                <div class="chip-group" id="educationChips">
                    <label class="chip"><input type="checkbox" name="education_levels" value="SKY"><span>SKY</span></label>
                    <label class="chip"><input type="checkbox" name="education_levels" value="ì¸ì„œìš¸"><span>ì¸ì„œìš¸</span></label>
                    <label class="chip"><input type="checkbox" name="education_levels" value="ì§€ê±°êµ­"><span>ì§€ê±°êµ­</span></label>
                    <label class="chip"><input type="checkbox" name="education_levels" value="4ë…„ì œ"><span>4ë…„ì œ</span></label>
                    <label class="chip"><input type="checkbox" name="education_levels" value="ì´í•˜"><span title="ì „ë¬¸ëŒ€(ì „ë¬¸í•™ì‚¬), ê³ ì¡¸, ê²€ì •ê³ ì‹œ ë“± 4ë…„ì œ ë¯¸ë§Œ">ì „ë¬¸ëŒ€/ê³ ì¡¸ ì´í•˜</span></label>
                </div>
                <small class="form-text">ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥. ì•„ë¬´ ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ìƒê´€ì—†ìŒìœ¼ë¡œ ì²˜ë¦¬</small>
                <small class="form-text">â€˜ì „ë¬¸ëŒ€/ê³ ì¡¸ ì´í•˜â€™ëŠ” ì „ë¬¸ëŒ€(2â€“3ë…„ì œÂ·ì „ë¬¸í•™ì‚¬), ê³ ì¡¸, ê²€ì •ê³ ì‹œ ë“± 4ë…„ì œ ë¯¸ë§Œì„ í¬í•¨í•©ë‹ˆë‹¤.</small>
            </div>

            <!-- ì—°ë´‰ ì¡°ê±´ (ë“€ì–¼ ìŠ¬ë¼ì´ë” + ì´ìƒ/ì´í•˜ + ìƒê´€ì—†ìŒ) -->
            <div class="form-group">
                <label>ì—°ë´‰ (ë§Œì›/ë…„)
                    <label class="any-toggle"><input type="checkbox" id="salaryAny"> ìƒê´€ì—†ìŒ</label>
                </label>
                <div class="range-row" id="salaryControls">
                    <input type="number" id="salaryMin" min="0" max="10000" step="100" placeholder="ìµœì†Œ" value="3000">
                    <div id="salarySlider" class="nu-slider"></div>
                    <input type="number" id="salaryMax" min="0" max="10000" step="100" placeholder="ìµœëŒ€" value="5000">
                </div>
                <small class="form-text" id="salaryHint">ì„ íƒ: 3000â€“5000ë§Œì›</small>
            </div>

            <!-- ì§ì—… ì¡°ê±´ (ì¹´í…Œê³ ë¦¬ ì²´í¬ë°•ìŠ¤/ë‹¤ì¤‘ì„ íƒ) -->
            <div class="form-group">
                <label>ì§ì—…
                    <label class="any-toggle"><input type="checkbox" id="occupationsAny" checked> ìƒê´€ì—†ìŒ</label>
                </label>
                <div class="checkbox-grid" id="occupationsGrid">
                    <label class="check-chip"><input type="checkbox" name="occupations" value="ì „ë¬¸ì§"> ì „ë¬¸ì§</label>
                    <label class="check-chip"><input type="checkbox" name="occupations" value="ê³µë¬´ì›"> ê³µë¬´ì›</label>
                    <label class="check-chip"><input type="checkbox" name="occupations" value="ê³µê¸°ì—…"> ê³µê¸°ì—…</label>
                    <label class="check-chip"><input type="checkbox" name="occupations" value="ê·¸ ì™¸"> ê·¸ ì™¸</label>
                </div>
                <small class="form-text">ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥. ì•„ë¬´ ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ìƒê´€ì—†ìŒìœ¼ë¡œ ì²˜ë¦¬</small>
            </div>

            <!-- ì§€ì—­ ì¡°ê±´ (ì‹œÂ·ë„ ë‹¤ì¤‘ ì„ íƒ + í”„ë¦¬ì…‹) -->
            <div class="form-group">
                <label>ì§€ì—­
                    <label class="any-toggle"><input type="checkbox" id="regionsAny"> ìƒê´€ì—†ìŒ</label>
                </label>
                <div class="chip-group" id="regionsChips">
                    <label class="chip"><input type="checkbox" name="regions" value="ì„œìš¸íŠ¹ë³„ì‹œ" checked><span>ì„œìš¸íŠ¹ë³„ì‹œ</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ë¶€ì‚°ê´‘ì—­ì‹œ"><span>ë¶€ì‚°ê´‘ì—­ì‹œ</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ëŒ€êµ¬ê´‘ì—­ì‹œ"><span>ëŒ€êµ¬ê´‘ì—­ì‹œ</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ì¸ì²œê´‘ì—­ì‹œ"><span>ì¸ì²œê´‘ì—­ì‹œ</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ê´‘ì£¼ê´‘ì—­ì‹œ"><span>ê´‘ì£¼ê´‘ì—­ì‹œ</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ëŒ€ì „ê´‘ì—­ì‹œ"><span>ëŒ€ì „ê´‘ì—­ì‹œ</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ìš¸ì‚°ê´‘ì—­ì‹œ"><span>ìš¸ì‚°ê´‘ì—­ì‹œ</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ"><span>ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ê²½ê¸°ë„"><span>ê²½ê¸°ë„</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ê°•ì›íŠ¹ë³„ìì¹˜ë„"><span>ê°•ì›íŠ¹ë³„ìì¹˜ë„</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ì¶©ì²­ë¶ë„"><span>ì¶©ì²­ë¶ë„</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ì¶©ì²­ë‚¨ë„"><span>ì¶©ì²­ë‚¨ë„</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ì „ë¶íŠ¹ë³„ìì¹˜ë„"><span>ì „ë¶íŠ¹ë³„ìì¹˜ë„</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ì „ë¼ë‚¨ë„"><span>ì „ë¼ë‚¨ë„</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ê²½ìƒë¶ë„"><span>ê²½ìƒë¶ë„</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ê²½ìƒë‚¨ë„"><span>ê²½ìƒë‚¨ë„</span></label>
                    <label class="chip"><input type="checkbox" name="regions" value="ì œì£¼íŠ¹ë³„ìì¹˜ë„"><span>ì œì£¼íŠ¹ë³„ìì¹˜ë„</span></label>
                </div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <button type="button" class="submit-btn" style="padding:0.4rem 0.9rem; font-size:0.9rem;" onclick="presetRegions('metro')">
                        ìˆ˜ë„ê¶Œ <span id="metroState" class="group-badge">0/3</span>
                    </button>
                    <button type="button" class="submit-btn" style="padding:0.4rem 0.9rem; font-size:0.9rem; background:#6c63ff;" onclick="presetRegions('big')">
                        ì§€ë°©ê´‘ì—­ì‹œ <span id="bigState" class="group-badge">0/5</span>
                    </button>
                    <button type="button" class="submit-btn" style="padding:0.4rem 0.9rem; font-size:0.9rem; background:#888;" onclick="presetRegions('clear')">ì „ì²´ í•´ì œ</button>
                </div>
            </div>

            <!-- ë‚˜ì´ ì¡°ê±´ (ë“€ì–¼ ìŠ¬ë¼ì´ë” + ìƒê´€ì—†ìŒ) -->
            <div class="form-group">
                <label>ë‚˜ì´ (ì„¸)
                    <label class="any-toggle"><input type="checkbox" id="ageAny"> ìƒê´€ì—†ìŒ</label>
                </label>
                <div class="range-row" id="ageControls">
                    <input type="number" id="ageMin" name="ageMin" min="18" max="100" placeholder="ìµœì†Œ" value="25">
                    <div id="ageSlider" class="nu-slider"></div>
                    <input type="number" id="ageMax" name="ageMax" min="18" max="100" placeholder="ìµœëŒ€" value="34">
                </div>
                <small class="form-text" id="ageHint">ì„ íƒ: 25â€“34ì„¸</small>
            </div>

            <!-- í¡ì—° ì—¬ë¶€ ì²´í¬ë°•ìŠ¤ -->
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="smoking" name="smoking" value="ë¹„í¡ì—°">
                    <span class="checkmark"></span>
                    ë¹„í¡ì—°ìë§Œ ì›í•¨
                </label>
                <small class="form-text">ì²´í¬í•˜ë©´ ì„±ë³„ í¡ì—°ìœ¨ì´ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤</small>
            </div>

            <!-- ì™¸ëª¨ ì¡°ê±´ (ìƒìœ„ í¼ì„¼íŠ¸ ë²”ìœ„: ë“€ì–¼ ìŠ¬ë¼ì´ë”) -->
            <div class="form-group">
                <label>ì™¸ëª¨ ìƒìœ„ í¼ì„¼íŠ¸(%)
                    <label class="any-toggle"><input type="checkbox" id="appearanceAny" checked> ìƒê´€ì—†ìŒ</label>
                </label>
                <div class="range-row" id="appearanceControls">
                    <input type="number" id="appearanceMin" min="0" max="100" step="1" value="0" disabled>
                    <div id="appearanceSlider" class="nu-slider"></div>
                    <input type="number" id="appearanceMax" min="1" max="100" step="1" value="20" disabled>
                </div>
                <small class="form-text" id="appearanceHint">ì„ íƒ: ìƒê´€ì—†ìŒ (ì„ íƒ ì‹œ ìƒìœ„ Aâ€“B% êµ¬ê°„ì„ ì˜ë¯¸)</small>
            </div>

            <!-- ì œì¶œ ë²„íŠ¼ -->
            <div class="form-group">
                <button type="submit" class="submit-btn">ì„ íƒë¥  ê³„ì‚°í•˜ê¸°</button>
            </div>
        </form>
    </div>

    <!-- ì‹¤ì‹œê°„ ìš”ì•½ -->
    <div class="summary-section" id="summarySection" style="display: none;">
        <h3>ì„ íƒí•œ ì¡°ê±´ ìš”ì•½</h3>
        <div id="selectedConditions" class="selected-conditions"></div>
        <div class="calculation-notice">
            <p>ğŸ’¡ ì„ íƒí•œ ì¡°ê±´ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì „ì²´ ì´ì„± ì¤‘ ëª‡ %ë¥¼ ì›í•˜ëŠ”ì§€ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
    <div class="result-section" id="resultSection" style="display: none;">
        <h2>ê³„ì‚° ê²°ê³¼</h2>
        <div class="result-card">
            <div class="percentage-display">
                <div class="percentage-circle">
                    <span id="percentageValue">0</span>%
                </div>
                <div class="percentage-label">
                    <span id="percentageLabel">ì „ì²´ ì´ì„± ì¤‘</span>
                </div>
            </div>
            
            <div class="result-details">
                <h3>ìƒì„¸ ë¶„ì„</h3>
                <div id="resultDetails"></div>
            </div>

            <!-- í˜„ì‹¤ì  í•´ì„ -->
            <div class="reality-check">
                <h3>ğŸ’¡ í˜„ì‹¤ì  í•´ì„</h3>
                <div id="realityMessage" class="reality-message"></div>
            </div>

            <!-- ê³µìœ  ì´ë¯¸ì§€ -->
            <div class="share-section">
                <h3>ê²°ê³¼ ê³µìœ í•˜ê¸°</h3>
                <div id="resultImage" class="result-image"></div>
                <button id="downloadBtn" class="download-btn">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
                <button id="shareBtn" class="share-btn">ê³µìœ í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© í‘œì‹œ -->
    <div class="loading-section" id="loadingSection" style="display: none;">
        <div class="loading-spinner"></div>
        <p>í†µê³„ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>
</div>

<!-- ì½”ë¯¹ ë©˜íŠ¸ ì˜ì—­ -->
<div class="comic-section" id="comicSection" style="display: none;">
    <h3>ğŸ’¬ í•œë§ˆë””</h3>
    <div id="comicMessage" class="comic-message"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    // noUiSlider ë¡œë“œ í™•ì¸ í›„ ì´ˆê¸°í™” ì¬ì‹œë„
    const startNoUi = () => {
        if (window.noUiSlider) {
            initNoUiDual('height', 140, 200, 1, [165, 175], 'cm');
            initNoUiDual('salary', 0, 10000, 100, [3000, 5000], 'ë§Œì›');
            initNoUiDual('age', 18, 100, 1, [25, 34], 'ì„¸');
            // ì™¸ëª¨: ì¡°ì‘ì€ ë¶€ë“œëŸ½ê²Œ(1ë‹¨ìœ„), ì„¸ë°€ ì¡°ì •ì€ ìˆ«ì ì…ë ¥ìœ¼ë¡œ
            initNoUiDual('appearance', 0, 100, 1, [0, 20], '%');
        } else {
            setTimeout(startNoUi, 50);
        }
    };
    startNoUi();
    // ì™¸ëª¨: noUiSlider ë“€ì–¼ í•¸ë“¤ë¡œ ê´€ë¦¬ë˜ë¯€ë¡œ ë‹¨ì¼ ìŠ¬ë¼ì´ë” ì„¸íŒ…ì€ ë¶ˆí•„ìš”
    bindAnyToggles();
    updateSummary();
});

// í¼ ì´ˆê¸°í™”
function initializeForm() {
    const form = document.getElementById('idealTypeForm');
    const inputs = form.querySelectorAll('select, input');
    
    // ì…ë ¥ê°’ ë³€ê²½ ì‹œ ìš”ì•½ ì—…ë°ì´íŠ¸
    inputs.forEach(input => {
        input.addEventListener('change', updateSummary);
        input.addEventListener('input', updateSummary);
    });
    
    // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
    const smokingCheckbox = document.getElementById('smoking');
    if (smokingCheckbox) {
        smokingCheckbox.addEventListener('change', updateSummary);
    }
    
    // í¼ ì œì¶œ ì²˜ë¦¬
    form.addEventListener('submit', handleFormSubmit);
}

// ì§€ì—­ í”„ë¦¬ì…‹ í† ê¸€
function presetRegions(type) {
    const chipInputs = Array.from(document.querySelectorAll('#regionsChips input[name=regions]'));
    const byValue = (v) => chipInputs.find(el => el.value === v);
    const setChecked = (vals) => {
        chipInputs.forEach(el => el.checked = false);
        vals.forEach(v => { const el = byValue(v); if (el) el.checked = true; });
        document.getElementById('regionsAny').checked = false;
        // í™œì„±í™” ë³´ì¥
        const chips = document.getElementById('regionsChips');
        chips.classList.remove('disabled');
        Array.from(chips.querySelectorAll('input')).forEach(el => el.disabled = false);
        updateRegionBadges();
        updateSummary();
    };
    if (type === 'metro') {
        setChecked(['ì„œìš¸íŠ¹ë³„ì‹œ', 'ê²½ê¸°ë„', 'ì¸ì²œê´‘ì—­ì‹œ']);
    } else if (type === 'big') {
        setChecked(['ë¶€ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ','ê´‘ì£¼ê´‘ì—­ì‹œ','ëŒ€ì „ê´‘ì—­ì‹œ','ìš¸ì‚°ê´‘ì—­ì‹œ']);
    } else {
        chipInputs.forEach(el => el.checked = false);
        document.getElementById('regionsAny').checked = true;
        bindAnyToggles();
        updateRegionBadges();
        updateSummary();
    }
}

// ì§€ì—­ ê·¸ë£¹ ë±ƒì§€ ì—…ë°ì´íŠ¸
function updateRegionBadges() {
    const selected = Array.from(document.querySelectorAll('#regionsChips input[name=regions]:checked')).map(el => el.value);
    const metro = ['ì„œìš¸íŠ¹ë³„ì‹œ', 'ê²½ê¸°ë„', 'ì¸ì²œê´‘ì—­ì‹œ'];
    const big = ['ë¶€ì‚°ê´‘ì—­ì‹œ','ëŒ€êµ¬ê´‘ì—­ì‹œ','ê´‘ì£¼ê´‘ì—­ì‹œ','ëŒ€ì „ê´‘ì—­ì‹œ','ìš¸ì‚°ê´‘ì—­ì‹œ'];
    const metroCount = metro.filter(v => selected.includes(v)).length;
    const bigCount = big.filter(v => selected.includes(v)).length;
    const metroBadge = document.getElementById('metroState');
    const bigBadge = document.getElementById('bigState');
    if (metroBadge) metroBadge.textContent = `${metroCount}/3`;
    if (bigBadge) bigBadge.textContent = `${bigCount}/5`;
}

// ì§€ì—­ ì¹© ì„ íƒ ë³€ê²½ ì‹œ ë±ƒì§€ ê°±ì‹ 
document.addEventListener('change', (e) => {
    if (e.target && e.target.matches('#regionsChips input[name=regions]')) {
        updateRegionBadges();
    }
});

// ì‹¤ì‹œê°„ ìš”ì•½ ì—…ë°ì´íŠ¸
function updateSummary() {
    const form = document.getElementById('idealTypeForm');
    const selectedConditions = [];

    // ì„±ë³„
    const gender = document.getElementById('gender').value;
    if (gender) selectedConditions.push(`ì„±ë³„: ${gender}`);

    // í‚¤
    if (document.getElementById('heightAny').checked) {
        selectedConditions.push('í‚¤: ìƒê´€ì—†ìŒ');
    } else {
        const hMin = document.getElementById('heightMin').value;
        const hMax = document.getElementById('heightMax').value;
        if (hMin && hMax) selectedConditions.push(`í‚¤: ${hMin}â€“${hMax}cm`);
    }

    // ì—°ë´‰
    if (document.getElementById('salaryAny').checked) {
        selectedConditions.push('ì—°ë´‰: ìƒê´€ì—†ìŒ');
    } else {
        const sMin = document.getElementById('salaryMin').value;
        const sMax = document.getElementById('salaryMax').value;
        if (sMin && sMax) selectedConditions.push(`ì—°ë´‰: ${sMin}â€“${sMax}ë§Œì›`);
    }

    // ë‚˜ì´
    if (document.getElementById('ageAny').checked) {
        selectedConditions.push('ë‚˜ì´: ìƒê´€ì—†ìŒ');
    } else {
        const aMin = document.getElementById('ageMin').value;
        const aMax = document.getElementById('ageMax').value;
        if (aMin && aMax) selectedConditions.push(`ë‚˜ì´: ${aMin}â€“${aMax}ì„¸`);
    }

    // í•™ë ¥ ë‹¤ì¤‘ (ìƒê´€ì—†ìŒ í† ê¸€ ë¬´ì‹œí•˜ê³  ì‹¤ì œ ì„ íƒ í‘œì‹œ)
    const eduLevelsSel = Array.from(document.querySelectorAll('input[name=education_levels]:checked')).map(el => el.value);
    if (eduLevelsSel.length) {
        selectedConditions.push(`í•™ë ¥(${eduLevelsSel.length}): ${eduLevelsSel.join(', ')}`);
    } else {
        selectedConditions.push('í•™ë ¥: ìƒê´€ì—†ìŒ');
    }

    // ì§ì—… ë‹¤ì¤‘
    const occAny = document.getElementById('occupationsAny').checked;
    if (!occAny) {
        const occs = Array.from(document.querySelectorAll('input[name=occupations]:checked')).map(el => el.value);
        if (occs.length) selectedConditions.push(`ì§ì—…: ${occs.join(', ')}`); else selectedConditions.push('ì§ì—…: ìƒê´€ì—†ìŒ');
    } else {
        selectedConditions.push('ì§ì—…: ìƒê´€ì—†ìŒ');
    }

    // ì™¸ëª¨ ìƒìœ„ í¼ì„¼íŠ¸
    if (document.getElementById('appearanceAny').checked) {
        selectedConditions.push('ì™¸ëª¨: ìƒê´€ì—†ìŒ');
    } else {
        const aMin = document.getElementById('appearanceMin').value;
        const aMax = document.getElementById('appearanceMax').value;
        if (aMin && aMax) selectedConditions.push(`ì™¸ëª¨: ìƒìœ„ ${aMin}â€“${aMax}%`);
    }

    // ì§€ì—­ ë‹¤ì¤‘ (ì‹¤ì œ ì„ íƒ í‘œì‹œ)
    const regs = Array.from(document.querySelectorAll('input[name=regions]:checked')).map(el => el.value);
    if (regs.length) selectedConditions.push(`ì§€ì—­(${regs.length}): ${regs.join(', ')}`); else selectedConditions.push('ì§€ì—­: ìƒê´€ì—†ìŒ');
    
    const summarySection = document.getElementById('summarySection');
    const selectedConditionsDiv = document.getElementById('selectedConditions');
    
    if (selectedConditions.length > 0) {
        selectedConditionsDiv.innerHTML = selectedConditions.map(condition => 
            `<div class="condition-item">â€¢ ${condition}</div>`
        ).join('');
        summarySection.style.display = 'block';
    } else {
        summarySection.style.display = 'none';
    }
}

// í¼ ì œì¶œ ì²˜ë¦¬
async function handleFormSubmit(event) {
    event.preventDefault();
    
    const filters = {};

    // ì„±ë³„
    const gender = document.getElementById('gender').value;
    if (!gender) { alert('ì´ìƒí˜•ì˜ ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    filters.gender = gender;

    // í‚¤ ë²”ìœ„
    if (!document.getElementById('heightAny').checked) {
        const hMin = parseInt(document.getElementById('heightMin').value);
        const hMax = parseInt(document.getElementById('heightMax').value);
        if (!Number.isInteger(hMin) || !Number.isInteger(hMax) || hMin < 140 || hMax > 200 || hMin >= hMax) {
            alert('ì˜¬ë°”ë¥¸ í‚¤ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (140-200cm, ìµœì†Œ < ìµœëŒ€).');
            return;
        }
        filters.height_range = [hMin, hMax];
    }

    // ì—°ë´‰ ë²”ìœ„
    if (!document.getElementById('salaryAny').checked) {
        const sMin = parseInt(document.getElementById('salaryMin').value);
        const sMax = parseInt(document.getElementById('salaryMax').value);
        if (!Number.isInteger(sMin) || !Number.isInteger(sMax) || sMin < 0 || sMax > 10000 || sMin >= sMax) {
            alert('ì˜¬ë°”ë¥¸ ì—°ë´‰ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (0-10000ë§Œì›, ìµœì†Œ < ìµœëŒ€).');
            return;
        }
        filters.salary_range = [sMin, sMax];
    }

    // ë‚˜ì´ ë²”ìœ„
    if (!document.getElementById('ageAny').checked) {
        const aMin = parseInt(document.getElementById('ageMin').value);
        const aMax = parseInt(document.getElementById('ageMax').value);
        if (!Number.isInteger(aMin) || !Number.isInteger(aMax) || aMin < 18 || aMax > 100 || aMin >= aMax) {
            alert('ì˜¬ë°”ë¥¸ ë‚˜ì´ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (18-100ì„¸, ìµœì†Œ < ìµœëŒ€).');
            return;
        }
        filters.age_range = [aMin, aMax];
    }

    // í•™ë ¥ ë‹¤ì¤‘
    {
        const levels = Array.from(document.querySelectorAll('input[name=education_levels]:checked')).map(el => el.value);
        if (levels.length) filters.education_levels = levels;
    }

    // ì§ì—… ë‹¤ì¤‘
    if (!document.getElementById('occupationsAny').checked) {
        const occs = Array.from(document.querySelectorAll('input[name=occupations]:checked')).map(el => el.value);
        if (occs.length) filters.occupations = occs;
    }

    // í¡ì—°
    if (document.getElementById('smoking').checked) {
        filters.smoking = 'ë¹„í¡ì—°';
    }

    // ì™¸ëª¨ ìƒìœ„ í¼ì„¼íŠ¸ ë²”ìœ„
    if (!document.getElementById('appearanceAny').checked) {
        const aMin = parseInt(document.getElementById('appearanceMin').value);
        const aMax = parseInt(document.getElementById('appearanceMax').value);
        if (!Number.isInteger(aMin) || !Number.isInteger(aMax) || aMin < 0 || aMax > 100 || aMin >= aMax) {
            alert('ì™¸ëª¨ ìƒìœ„ í¼ì„¼íŠ¸ëŠ” 0-100 ì‚¬ì´, ìµœì†Œ < ìµœëŒ€ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        filters.appearance_top_percent_range = [aMin, aMax];
    }

    // ì§€ì—­ ë‹¤ì¤‘
    {
        const regs = Array.from(document.querySelectorAll('input[name=regions]:checked')).map(el => el.value);
        if (regs.length) filters.regions = regs;
    }
    
    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!filters.gender) {
        alert('ì´ìƒí˜•ì˜ ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
        return;
    }
    
    // ë¡œë”© í‘œì‹œ
    showLoading();
    
    try {
        // API í˜¸ì¶œ
        const response = await fetch('/api/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filters)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResult(result.data);
            generateRealityMessage(result.data);
            generateComicMessage(result.data);
        } else {
            alert('ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.message);
        }
        
    } catch (error) {
        console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
        alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

// noUiSlider ê¸°ë°˜ ë“€ì–¼ í•¸ë“¤ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
function initNoUiDual(prefix, min, max, step, start, unit) {
    const slider = document.getElementById(prefix + 'Slider');
    const minNum = document.getElementById(prefix + 'Min');
    const maxNum = document.getElementById(prefix + 'Max');
    const hint = document.getElementById(prefix + 'Hint');
    if (!slider || !minNum || !maxNum || !window.noUiSlider) return;

    noUiSlider.create(slider, {
        start: start,
        connect: true,
        range: { min: min, max: max },
        step: step,
        behaviour: 'tap-drag'
    });

    slider.noUiSlider.on('update', (values) => {
        const v0 = Math.round(values[0]);
        const v1 = Math.round(values[1]);
        if (parseInt(minNum.value) !== v0) minNum.value = v0;
        if (parseInt(maxNum.value) !== v1) maxNum.value = v1;
        if (hint) {
            if (prefix === 'appearance') {
                hint.textContent = `ì„ íƒ: ìƒìœ„ ${v0}â€“${v1}%`;
            } else {
                hint.textContent = `ì„ íƒ: ${v0}â€“${v1}${unit}`;
            }
        }
    });

    const clamp = (v) => Math.max(min, Math.min(max, v));
    const applyFromInputs = () => {
        const rawMin = parseInt(minNum.value);
        const rawMax = parseInt(maxNum.value);
        if (!Number.isInteger(rawMin) || !Number.isInteger(rawMax)) return;
        const v0 = clamp(rawMin);
        const v1 = clamp(rawMax);
        if (prefix === 'appearance' && v0 === v1) {
            // ìµœì†Œ/ìµœëŒ€ê°€ ê°™ì€ ê²½ìš°, í•œ ì¹¸ í™•ì¥í•˜ì—¬ ì„¸íŒ…
            const bump = step || 1;
            const nv1 = clamp(v1 + bump);
            if (nv1 > v1) {
                slider.noUiSlider.set([v0, nv1]);
                return;
            }
        }
        if (v0 >= v1) return; // ìœ íš¨ ë²”ìœ„ ì•„ë‹ ë•Œ ë¬´ì‹œí•˜ê³  ì‚¬ìš©ìê°€ ê³„ì† ì…ë ¥í•  ìˆ˜ ìˆê²Œ ë‘ 
        slider.noUiSlider.set([v0, v1]);
    };
    ['change'].forEach(ev => {
        minNum.addEventListener(ev, applyFromInputs);
        maxNum.addEventListener(ev, applyFromInputs);
    });
    const onEnter = (e, el) => { if (e.key === 'Enter') { e.preventDefault(); applyFromInputs(); el.blur(); } };
    minNum.addEventListener('keydown', (e) => onEnter(e, minNum));
    maxNum.addEventListener('keydown', (e) => onEnter(e, maxNum));
}

// ë‹¨ì¼ ìŠ¬ë¼ì´ë”(ì™¸ëª¨ ë“±)ì™€ ìˆ«ì ì…ë ¥ ë™ê¸°í™”
function setupSingleRange(prefix) {
    const any = document.getElementById(prefix + 'Any');
    const num = document.getElementById(prefix + 'Min');
    const slider = document.getElementById(prefix + 'L');
    const controls = document.getElementById(prefix + 'Controls');
    const hint = document.getElementById(prefix + 'Hint');
    if (!num || !slider) return;
    const unit = prefix === 'appearance' ? '% (ìƒìœ„)' : '';
    function sync() {
        const v = parseInt(slider.value);
        num.value = v;
        if (hint) hint.textContent = `ì„ íƒ: ìƒìœ„ ${v}% ì´ìƒ`;
    }
    slider.addEventListener('input', sync);
    num.addEventListener('input', () => {
        slider.value = num.value;
        sync();
    });
}

// ìƒê´€ì—†ìŒ í† ê¸€ ë°”ì¸ë”©
function bindAnyToggles() {
    [
        { any: 'heightAny', controls: 'heightControls', hint: 'heightHint', text: 'ì„ íƒ: ìƒê´€ì—†ìŒ' },
        { any: 'salaryAny', controls: 'salaryControls', hint: 'salaryHint', text: 'ì„ íƒ: ìƒê´€ì—†ìŒ' },
        { any: 'ageAny', controls: 'ageControls', hint: 'ageHint', text: 'ì„ íƒ: ìƒê´€ì—†ìŒ' },
        { any: 'educationAny', controls: 'educationChips' },
        { any: 'occupationsAny', controls: 'occupationsGrid' },
        { any: 'regionsAny', controls: 'regionsChips' },
        { any: 'appearanceAny', controls: 'appearanceControls', hint: 'appearanceHint', text: 'ì„ íƒ: ìƒê´€ì—†ìŒ (ì„ íƒ ì‹œ ìƒìœ„ Aâ€“B% êµ¬ê°„ì„ ì˜ë¯¸)' },
    ].forEach(cfg => {
        const anyEl = document.getElementById(cfg.any);
        const controlsEl = document.getElementById(cfg.controls);
        const hintEl = cfg.hint ? document.getElementById(cfg.hint) : null;
        if (!anyEl || !controlsEl) return;
        const setDisabled = (disabled) => {
            controlsEl.classList.toggle('disabled', disabled);
            Array.from(controlsEl.querySelectorAll('input, select')).forEach(el => el.disabled = disabled);
            if (hintEl && cfg.text) hintEl.textContent = disabled ? cfg.text : hintEl.textContent;
        };
        setDisabled(anyEl.checked);
        anyEl.addEventListener('change', () => setDisabled(anyEl.checked));
    });
}

// ê²°ê³¼ í‘œì‹œ
function displayResult(resultData) {
    const resultSection = document.getElementById('resultSection');
    const percentageValue = document.getElementById('percentageValue');
    const percentageLabel = document.getElementById('percentageLabel');
    const resultDetails = document.getElementById('resultDetails');
    
    // í™•ë¥  ë° ë“±ê¸‰ í‘œì‹œ
    percentageValue.textContent = resultData.probability;
    percentageLabel.textContent = `ì „ì²´ ${resultData.filters.gender} ì¤‘`;
    
    // ê°„ê²°í•œ ê³„ì‚° ê³¼ì •(ì¡°ê±´ + ë¹„ìœ¨ ë³€í™”ë§Œ) + ë§ˆì§€ë§‰ì— ì¸ì›ìˆ˜
    const details = resultData.calculation_details;
    resultDetails.innerHTML = renderCondAndRates(details.explanation_steps, resultData.population, resultData.probability);
    
    // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
    resultSection.style.display = 'block';
    
    // ì´ë¯¸ì§€ ìƒì„±
    generateResultImage(resultData);
}

function renderCondAndRates(steps, population, probability) {
    if (!Array.isArray(steps) || steps.length === 0) return '';
    const items = steps.map(s => {
        const fromP = (typeof s.from_percent === 'number') ? s.from_percent.toFixed(2) : s.from_percent;
        const toP = (typeof s.to_percent === 'number') ? s.to_percent.toFixed(2) : s.to_percent;
        return `<li>${s.label}${s.value ? ` (${s.value})` : ''}: ${fromP}% â†’ ${toP}%</li>`;
    }).join('');
    let finalCount = null;
    const last = steps[steps.length - 1];
    if (last && typeof last.to_count === 'number') {
        finalCount = last.to_count;
    } else if (population && population.total && typeof probability === 'number') {
        finalCount = Math.round((probability / 100) * population.total);
    }
    const finalLine = finalCount !== null ? `<p style="margin-top:0.5rem;"><strong>ìµœì¢… ì˜ˆìƒ ì¸ì›ìˆ˜:</strong> ì•½ ${finalCount.toLocaleString()}ëª…</p>` : '';
    return `
    <div class="result-details" style="margin-top:1rem;">
        <h3>ê³„ì‚° ê³¼ì •</h3>
        <ol style="margin-left:1.2rem; line-height:1.6;">${items}</ol>
        ${finalLine}
    </div>`;
}

// í˜„ì‹¤ì  í•´ì„ ë©”ì‹œì§€ ìƒì„±
function generateRealityMessage(resultData) {
    const realitySection = document.getElementById('realityMessage');
    const percentage = resultData.probability;
    
    let message = '';
    
    if (percentage < 0.1) {
        message = 'ğŸ¯ ì´ ì •ë„ë©´ ë¡œë˜ ë‹¹ì²¨ë³´ë‹¤ ì–´ë ¤ì›Œìš”! ì´ëŸ° ì¡°ê±´ì„ ì›í•œë‹¤ë©´ ì •ë§ íŠ¹ë³„í•œ ì‚¬ëŒì„ ì°¾ì•„ì•¼ í•  ê²ƒ ê°™ì•„ìš”.';
    } else if (percentage < 1.0) {
        message = 'ğŸŒŸ ë§¤ìš° ë“œë¬¸ ì¡°ê±´ì´ë„¤ìš”! 100ëª… ì¤‘ 1ëª…ë„ ì•ˆ ë˜ëŠ” ë¹„ìœ¨ì´ì—ìš”. ì¸ë‚´ì‹¬ì´ í•„ìš”í•  ê²ƒ ê°™ì•„ìš”.';
    } else if (percentage < 5.0) {
        message = 'ğŸ’ ê½¤ íŠ¹ë³„í•œ ì¡°ê±´ì´ì—ìš”! 20ëª… ì¤‘ 1ëª… ì •ë„ì˜ ë¹„ìœ¨ì´ë„¤ìš”. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ë©´ ë§Œë‚  ìˆ˜ ìˆì„ ê±°ì˜ˆìš”.';
    } else if (percentage < 15.0) {
        message = 'âœ¨ í˜„ì‹¤ì ì´ë©´ì„œë„ ë‚˜ë¦„ íŠ¹ë³„í•œ ì¡°ê±´ì´ì—ìš”! 7ëª… ì¤‘ 1ëª… ì •ë„ë¼ë©´ ì¶©ë¶„íˆ ë§Œë‚  ìˆ˜ ìˆì„ ê±°ì˜ˆìš”.';
    } else if (percentage < 30.0) {
        message = 'ğŸ˜Š ë¬´ë‚œí•˜ê³  ì¢‹ì€ ì¡°ê±´ì´ë„¤ìš”! 3ëª… ì¤‘ 1ëª… ì •ë„ë¼ë©´ ì£¼ë³€ì—ì„œ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆì„ ê±°ì˜ˆìš”.';
    } else {
        message = 'ğŸŒ± ë§¤ìš° í˜„ì‹¤ì ì¸ ì¡°ê±´ì´ì—ìš”! 3ëª… ì¤‘ 1ëª… ì´ìƒì´ë¼ë©´ ì£¼ë³€ì— ë§ì´ ìˆì„ ê±°ì˜ˆìš”.';
    }
    
    realitySection.textContent = message;
}

// ê²°ê³¼ ì´ë¯¸ì§€ ìƒì„±
async function generateResultImage(resultData) {
    try {
        const response = await fetch('/api/generate-image', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(resultData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            const resultImage = document.getElementById('resultImage');
            resultImage.innerHTML = `<img src="${result.data.image_data}" alt="ê²°ê³¼ ì¹´ë“œ" style="max-width: 100%; height: auto;">`;
        }
        
    } catch (error) {
        console.error('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:', error);
    }
}

// ì½”ë¯¹ ë©˜íŠ¸ ìƒì„±
function generateComicMessage(resultData) {
    const comicSection = document.getElementById('comicSection');
    const comicMessage = document.getElementById('comicMessage');
    
    const percentage = resultData.probability;
    
    let message = '';
    
    if (percentage < 0.1) {
        message = 'ì´ëŸ° ì¡°ê±´ì„ ì›í•œë‹¤ë©´... ì°¨ë¼ë¦¬ ì™¸ê³„ì¸ì„ ì°¾ëŠ” ê²Œ ë” ì‰¬ìš¸ ìˆ˜ë„? ğŸ‘½';
    } else if (percentage < 1.0) {
        message = '100ëª… ì¤‘ 1ëª…ë„ ì•ˆ ëœë‹¤ë‹ˆ... ì¸ë‚´ì‹¬ì˜ ì‹œí—˜ì´ë„¤ìš”! ğŸ§˜â€â™€ï¸';
    } else if (percentage < 5.0) {
        message = '20ëª… ì¤‘ 1ëª…ì´ë¼ë©´... ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë¦¬ë©´ ë‚˜íƒ€ë‚  ê±°ì˜ˆìš”! â°';
    } else if (percentage < 15.0) {
        message = '7ëª… ì¤‘ 1ëª…ì´ë¼ë©´ ì¶©ë¶„íˆ í˜„ì‹¤ì ì´ì—ìš”! ì£¼ë³€ì„ ë‘˜ëŸ¬ë³´ì„¸ìš”! ğŸ‘€';
    } else if (percentage < 30.0) {
        message = '3ëª… ì¤‘ 1ëª…ì´ë¼ë©´ ì£¼ë³€ì— ë§ì´ ìˆì„ ê±°ì˜ˆìš”! ëˆˆì„ í¬ê²Œ ëœ¨ê³  ì°¾ì•„ë³´ì„¸ìš”! ğŸ‘ï¸';
    } else {
        message = '3ëª… ì¤‘ 1ëª… ì´ìƒì´ë¼ë©´... ì´ë¯¸ ì£¼ë³€ì— ìˆì„ ìˆ˜ë„? ë‹¤ì‹œ í•œë²ˆ ë‘˜ëŸ¬ë³´ì„¸ìš”! ğŸ”';
    }
    
    comicMessage.textContent = message;
    comicSection.style.display = 'block';
}

// ë¡œë”© í‘œì‹œ
function showLoading() {
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('comicSection').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingSection').style.display = 'none';
}

// ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
document.getElementById('downloadBtn')?.addEventListener('click', function() {
    const img = document.querySelector('#resultImage img');
    if (img) {
        const link = document.createElement('a');
        link.download = 'ì´ìƒí˜•_ì„ íƒë¥ _ê²°ê³¼.png';
        link.href = img.src;
        link.click();
    }
});

// ê³µìœ í•˜ê¸°
document.getElementById('shareBtn')?.addEventListener('click', function() {
    if (navigator.share) {
        navigator.share({
            title: 'ì´ìƒí˜• ì„ íƒë¥  ë¶„ì„ ê²°ê³¼',
            text: 'ë‚´ê°€ ì›í•˜ëŠ” ì´ìƒí˜•ì´ ì „ì²´ ì´ì„± ì¤‘ ëª‡ %ì¸ì§€ ê³„ì‚°í•´ë´¤ì–´ìš”!',
            url: window.location.href
        });
    } else {
        // í´ë¦½ë³´ë“œì— ë³µì‚¬
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });
    }
});
</script>
{% endblock %} 